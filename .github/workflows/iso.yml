name: Build ArchISO and Upload

on:
  workflow_dispatch:
  push:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    env:
      UPLOAD_URL: https://kogaslife.duckdns.org/israrepo/uploadiso.php

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build ISO inside Arch Docker
        env:
          DOCKER_BIN: "sudo docker"
        run: |
          chmod +x ./build_docker.sh
          ./build_docker.sh

      - name: Find generated ISO
        id: find_iso
        run: |
          ISO_PATH=$(ls -1 out/*.iso | head -n 1 || true)

          if [ -z "$ISO_PATH" ]; then
            echo "No se encontró ningún ISO en out/*.iso"
            ls -R
            exit 1
          fi

          echo "ISO_PATH=$ISO_PATH"
          echo "iso_path=$ISO_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload ISO with retries
        env:
          ISO_PATH: ${{ steps.find_iso.outputs.iso_path }}
          UPLOAD_URL: ${{ env.UPLOAD_URL }}
        run: |
          attempts=0
          max_retries=6

          while true; do
            attempts=$((attempts + 1))
            echo "Intento de subida $attempts..."

            if curl --fail --show-error -F "file=@${ISO_PATH}" "${UPLOAD_URL}"; then
              echo "✅ Subida completada correctamente."
              break
            fi

            if [ "$attempts" -gt "$max_retries" ]; then
              echo "❌ Fallo al subir tras $max_retries reintentos."
              exit 1
            fi

            echo "⚠️ Fallo en la subida, reintentando en 15 segundos..."
            sleep 15
          done

