name: Build ArchISO and Upload

on:
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: self-hosted

    env:
      UPLOAD_URL: https://kogaslife.duckdns.org/israrepo/uploadiso.php

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate ISO
        env:
          UPLOAD_URL: ${{ env.UPLOAD_URL }}
        run: |
          attempts=0
          max_retries=6

          while true; do
            attempts=$((attempts + 1))
            echo "Intento de subida $attempts..."

            if curl --fail --show-error -F "file=@${ISO_PATH}" "${UPLOAD_URL}"; then
              echo "✅ Subida completada correctamente."
              break
            fi

            if [ "$attempts" -gt "$max_retries" ]; then
              echo "❌ Fallo al subir tras $max_retries reintentos."
              exit 1
            fi

            echo "⚠️ Fallo en la subida, reintentando en 15 segundos..."
            sleep 15
          done

