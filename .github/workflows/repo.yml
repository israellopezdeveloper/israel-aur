name: Build & Sign Arch Repo

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 */12 * * *'

jobs:
  regenerating-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    container:
      image: archlinux:latest
    steps:
      - name: Install packages
        run: pacman -Syu --noconfirm git openssh sudo debugedit base-devel curl
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
      - name: Create non-root user
        run: |
          useradd -m builder
          passwd -d builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .
      - name: Sign any unsigned packages
        env:
          GPG_KEYID: ${{ secrets.GPG_KEYID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          any=0
          CURR_DIR="$(pwd)"
          AUR_PACKAGES=$(cat aur_packages.txt)
          cd /tmp
          for pkg in ${AUR_PACKAGES[@]}; do
            echo "========================== ${pkg} =========================="
            sudo -u builder bash -c " \
                git clone \"https://aur.archlinux.org/${pkg}.git\" > /dev/null; \
                cd \"${pkg}\"; \
                makepkg -sf --noconfirm --skippgpcheck \
                  && echo 'PACKAGE created' \
                  || echo '=========== ERROR on creating package ==========='; \
                mv *.tar.zst ..;"
            ls -lisah
            rm *-debug* > /dev/null 2>&1 || true
            pacman -U --noconfirm ./*.tar.zst \
                  && echo 'PACKAGE installed!!!!!' \
                  || echo '========= ERROR on installing package ==========='
            mv *.tar.zst "${CURR_DIR}/x86_64"
            rm -rf "${pkg}" > /dev/null 2>&1
            echo "========================== ${pkg} =========================="
            echo -e ".\n.\n.\n.\n.\n.\n"
          done
          cd "${CURR_DIR}"
          for pkg in x86_64/*.pkg.tar.*; do
            [ -e "$pkg" ] || continue
            if [[ "${pkg}" == *sig ]]; then
              continue
            fi
            gpg --batch --yes --pinentry-mode loopback \
              --local-user "$GPG_KEYID" \
              --passphrase "$GPG_PASSPHRASE" \
              --detach-sign "$pkg"
          done
          ls -l x86_64

      - name: Upload repo files to remote server
        env:
          UPLOAD_URL: https://kogaslife.duckdns.org/israrepo/upload.php
        run: |
          set -e
          echo "Subiendo ficheros de x86_64/ a ${UPLOAD_URL}"
          for f in x86_64/*; do
            [ -f "$f" ] || continue

            max_retries=3
            retry=1
            success=0

            while [ $retry -le $max_retries ]; do
              echo "==> Uploading $f (attempt $retry/$max_retries)"
              if curl -sS -X POST -F "fileToUpload=@${f}" "$UPLOAD_URL"; then
                echo "‚úÖ Upload succeeded for $f"
                success=1
                break
              else
                echo "‚ùå Upload failed for $f"
              fi
              retry=$((retry + 1))
              sleep 2
            done

            if [ $success -ne 1 ]; then
              echo "üö® Upload failed after $max_retries attempts for $f"
            fi
          done
