#!/usr/bin/env bash
set -euo pipefail

# Configurar makepkg para usar todos los núcleos
(
  cd /tmp
  sudo sed -i "s/-j[0-9]*/-j$(nproc)/" /etc/makepkg.conf
  sudo sed -i "s/--threads=[0-9]*/--threads=$(nproc)/" /etc/makepkg.conf
  sudo sed -i "s/!debug/debug/" /etc/makepkg.conf
  git clone https://aur.archlinux.org/yay.git &>/dev/null
  cd yay
  makepkg -si --noconfirm &>/dev/null
  cd "$GITHUB_WORKSPACE"
)

DEST_DIR="${GITHUB_WORKSPACE}/x86_64"
BIG_DIR="${GITHUB_WORKSPACE}/big"
LISTA="aur_packages.txt"

mkdir -p "$DEST_DIR"
mkdir -p "$BIG_DIR"

# Leer paquetes, ignorar vacíos y comentarios
mapfile -t PKGS < <(grep -Ev '^\s*($|#)' "$LISTA")

echo "Paquetes a construir: ${#PKGS[@]}"

# CacheDir real de pacman
PACMAN_CACHEDIR="$(pacman-conf CacheDir | head -n1 || true)"
: "${PACMAN_CACHEDIR:=/var/cache/pacman/pkg}"

# CacheDir de yay (donde guarda los paquetes AUR)
YAY_CACHEDIR="${XDG_CACHE_HOME:-$HOME/.cache}/yay"

echo "Cache de pacman: $PACMAN_CACHEDIR"
echo "Cache de yay: $YAY_CACHEDIR"

# Construye/instala todo en un solo comando
yay -S --mflags "--nocheck --skipinteg" --needed --noconfirm --cleanafter=false "${PKGS[@]}"

# Copiar TODOS los paquetes de los paquetes AUR construidos
for pkg in "${PKGS[@]}"; do
  # Buscar en el cache de yay
  if [ -d "$YAY_CACHEDIR" ]; then
    find "$YAY_CACHEDIR" -type f \
      \( -name "*.pkg.tar.zst" -o -name "*.pkg.tar.xz" \) \
      -path "*/$pkg/*" -exec cp -t "$DEST_DIR" {} + 2>/dev/null || true
  fi
  
  # También buscar en el cache de pacman
  find "$PACMAN_CACHEDIR" -type f \
    \( -name "*.pkg.tar.zst" -o -name "*.pkg.tar.xz" \) \
    -name "*$pkg*" -exec cp -t "$DEST_DIR" {} + 2>/dev/null || true
done

find "$DEST_DIR" -type f \
  \( -name "*.pkg.tar.zst" -o -name "*.pkg.tar.xz" \) \
  -size +100M -print -exec mv {} "$BIG_DIR" \;
echo "Paquetes copiados a $DEST_DIR:"
ls -lah "$DEST_DIR" | sed -n '1,200p'

