name: Build & Sign Arch Repo

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 */12 * * *'

jobs:
  regenerating-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    container:
      image: archlinux:latest
    steps:
      - name: Install packages
        run: pacman -Syu --noconfirm git openssh sudo debugedit base-devel curl jq

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Create non-root user
        run: |
          useradd -m builder
          passwd -d builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Build AUR packages
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          sudo -u builder --preserve-env=GITHUB_WORKSPACE GITHUB_WORKSPACE="$GITHUB_WORKSPACE" bash ./build

      - name: Rebuild signed repo database
        env:
          REPO_NAME: israrepo
          GPG_KEYID: ${{ secrets.GPG_KEYID }}
        run: |
          set -euo pipefail

          count=$(ls -1 x86_64/*.pkg.tar.zst 2>/dev/null | wc -l || true)
          if [ "$count" -eq 0 ]; then
            echo "No hay paquetes; se omite reconstrucciÃ³n de la DB."
            exit 0
          fi

          echo "==> Signing packages (.sig)..."
          for pkg in "${pkgs[@]}"; do
            sig="${pkg}.sig"

            # Si ya existe firma, la regeneramos (evita firmas antiguas/rotas)
            rm -f "$sig"

            gpg --batch --yes \
              --local-user "${GPG_KEYID}" \
              --detach-sign --armor \
              --output "$sig" \
              "$pkg"
          done

          echo "==> Building & signing repo database..."
          repo-add -s -k "${GPG_KEYID}" -R \
            "x86_64/${REPO_NAME}.db.tar.gz" \
            x86_64/*.pkg.tar.zst > /dev/null 2>log.log \
            && echo " ==> DONE!!" \
            || { echo " ==> FAILED"; cat log.log; false; }

          rm -f log.log
          rm -f "x86_64/${REPO_NAME}.db" "x86_64/${REPO_NAME}.files" || true
          cp "x86_64/${REPO_NAME}.db.tar.gz"    "x86_64/${REPO_NAME}.db"
          cp "x86_64/${REPO_NAME}.files.tar.gz" "x86_64/${REPO_NAME}.files"


      - name: Generate index.html
        run: |
          set -euo pipefail

          FILES=""
          for i in x86_64/*; do
            [ -f "$i" ] || continue
            if [ "$(basename "$i")" = "index.html" ]; then
              continue
            fi
            FILE_NAME="$(basename "${i}")"
            FILE_SIZE="$(stat -c "%s" "${i}" | numfmt --to=iec)"
            FILES="${FILES}<tr><td><a href=\"https://israellopezdeveloper.github.io/israel-aur/$i\">${FILE_NAME}</a></td><td>${FILE_SIZE}</td></tr>"
          done

          cat > x86_64/index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="es">
            <head>
              <meta charset="utf-8">
              <title>Israel's Repo (/x86_64)</title>
              <link href="../style.css" rel="stylesheet" />
            </head>
            <body>
              <h1 class="retrocursor">Israel's Repo (/x86_64)</h1>
              <table>
                <thead>
                  <tr>
                    <th>File</th>
                    <th>Size</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><a href="..">..</a></td>
                    <td></td>
                  </tr>
          HTML

          echo "${FILES}" >> x86_64/index.html

          cat >> x86_64/index.html <<'HTML'
                </tbody>
              </table>
            </body>
          </html>
          HTML

      - name: Upload repo files
        env:
          UPLOAD_URL: https://kogaslife.duckdns.org/israel-aur/upload.php
        run: |
          set -euo pipefail
          echo "Subiendo ficheros de x86_64/ a ${UPLOAD_URL}"

          max_retries=6

          upload_one () {
            local f="$1"
            local retry=1
            while [ $retry -le $max_retries ]; do
              echo "==> Uploading $f (attempt $retry/$max_retries)"
              if curl -sS -X POST -F "fileToUpload=@${f}" "$UPLOAD_URL"; then
                echo "âœ… Upload succeeded for $f"
                return 0
              fi
              echo "âŒ Upload failed for $f"
              retry=$((retry + 1))
              sleep 2
            done
            echo "ðŸš¨ Upload failed after $max_retries attempts for $f"
            return 1
          }

          shopt -s nullglob
          for f in big/*; do
            [ -f "$f" ] || continue
            upload_one "$f" || true
          done

      - name: Set SSH
        env:
          REPO_NAME: israrepo
          DEPLOY_KEY_PRIV: ${{ secrets.DEPLOY_KEY_PRIV }}
          DEPLOY_KEY_PUB: ${{ secrets.DEPLOY_KEY_PUB }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${DEPLOY_KEY_PRIV}" > ~/.ssh/id_ed25519
          echo "${DEPLOY_KEY_PUB}" > ~/.ssh/id_ed25519.pub
          chmod 600 ~/.ssh/id_ed25519 || true
          chmod 644 ~/.ssh/id_ed25519.pub || true
          ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> ~/.ssh/known_hosts

      - name: Commit & push if changed
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          echo "Workspace: ${GITHUB_WORKSPACE}"
          ls -lisah "${GITHUB_WORKSPACE}/x86_64" || true

          cd "${GITHUB_WORKSPACE}"
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin gh-pages
          rm -rf /tmp/gh-pages
          git worktree add /tmp/gh-pages gh-pages

          cd /tmp/gh-pages
          mkdir -p x86_64
          rm -rf x86_64/*

          max_bytes=$((100 * 1024 * 1024))  # 100MB

          echo "Copiando a gh-pages solo ficheros < 100MB (${max_bytes} bytes)"

          shopt -s nullglob
          for src in "${GITHUB_WORKSPACE}/x86_64/"*; do
            [ -f "$src" ] || continue
            base="$(basename "$src")"
            size="$(stat -c '%s' "$src")"

            if [ "$size" -lt "$max_bytes" ]; then
              echo "âœ… + $base ($(numfmt --to=iec "$size"))"
              cp -f "$src" "x86_64/$base"
            else
              echo "â­ï¸  - $base ($(numfmt --to=iec "$size")) [SKIP >=100MB]"
            fi
          done

          echo "Contenido final a publicar:"
          ls -lisah x86_64 | sed -n '1,200p'

          git add .
          if git diff --cached --quiet; then
            echo "No hay cambios en gh-pages; nada que commitear."
            exit 0
          fi

          git commit -m "Update signed repo database"
          git push origin gh-pages

          cd "${GITHUB_WORKSPACE}"
          git worktree remove /tmp/gh-pages --force || true
